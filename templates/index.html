<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Test - Sprinfy Homelab</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="grid">
            <!-- Información del sistema -->
            <div class="card">
                <h2>📊 Estado del Sistema</h2>
                <div id="system-info">
                    <div class="metric">
                        <span class="label">CPU:</span>
                        <span class="value" id="cpu-usage">-</span>
                    </div>
                    <div class="metric">
                        <span class="label">RAM:</span>
                        <span class="value" id="memory-usage">-</span>
                    </div>
                    <div class="metric">
                        <span class="label">Disco:</span>
                        <span class="value" id="disk-usage">-</span>
                    </div>
                </div>
            </div>

            <!-- Configuración de prueba -->
            <div class="card">
                <h2>⚙️ Configuración de Prueba</h2>
                <form id="load-test-form">
                    <div class="form-group">
                        <label for="url">URL de destino:</label>
                        <input type="url" id="url" value="https://heimdall.sprinfy.com" required>
                    </div>
                    <div class="form-group">
                        <label for="requests">Número de requests:</label>
                        <input type="number" id="requests" value="100" min="1" max="50000" required>
                    </div>
                    <div class="form-group">
                        <label for="concurrency">Concurrencia:</label>
                        <input type="number" id="concurrency" value="10" min="1" max="500" required>
                    </div>
                    <button type="submit" id="start-test" class="btn-primary">Iniciar Prueba</button>
                </form>
            </div>

            <!-- Resultados de prueba -->
            <div class="card">
                <h2>📈 Resultados</h2>
                <div id="test-results">
                    <div id="test-status">Listo para prueba</div>
                    <div id="test-stats" style="display: none;"></div>
                </div>
                <canvas id="response-chart" style="display: none;"></canvas>
            </div>

            <!-- Prueba de servicios locales -->
            <div class="card">
                <h2>🏠 Servicios Locales</h2>
                <button id="test-local" class="btn-secondary">Probar Servicios</button>
                <div id="local-results"></div>
            </div>
        </div>
    </div>

    <script>
        let systemInfoInterval;
        let testStatusInterval;
        let responseChart;

        // Actualizar información del sistema
        function updateSystemInfo() {
            fetch('/api/system-info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cpu-usage').textContent = data.cpu_percent + '%';
                    document.getElementById('memory-usage').textContent = 
                        `${data.memory_percent}% (${data.memory_used_gb}GB/${data.memory_total_gb}GB)`;
                    document.getElementById('disk-usage').textContent = 
                        `${data.disk_percent}% (${data.disk_used_gb}GB/${data.disk_total_gb}GB)`;
                })
                .catch(error => console.error('Error:', error));
        }

        // Iniciar prueba de carga
        document.getElementById('load-test-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = document.getElementById('url').value;
            const requests = document.getElementById('requests').value;
            const concurrency = document.getElementById('concurrency').value;
            
            fetch('/api/load-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: url,
                    requests: requests,
                    concurrency: concurrency
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    document.getElementById('test-status').textContent = 'Prueba en curso...';
                    document.getElementById('start-test').disabled = true;
                    document.getElementById('start-test').textContent = 'Ejecutando...';
                    
                    // Iniciar monitoreo del test
                    testStatusInterval = setInterval(checkTestStatus, 1000);
                }
            })
            .catch(error => console.error('Error:', error));
        });

        // Verificar estado del test
        function checkTestStatus() {
            fetch('/api/load-test')
                .then(response => response.json())
                .then(data => {
                    if (!data.running && data.results.stats) {
                        // Test completado
                        clearInterval(testStatusInterval);
                        displayResults(data.results);
                        document.getElementById('start-test').disabled = false;
                        document.getElementById('start-test').textContent = 'Iniciar Prueba';
                    } else if (data.results.completed_requests) {
                        // Test en progreso
                        document.getElementById('test-status').textContent = 
                            `Progreso: ${data.results.completed_requests}/${data.results.num_requests} requests`;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Mostrar resultados
        function displayResults(results) {
            const stats = results.stats;
            const statusDiv = document.getElementById('test-status');
            const statsDiv = document.getElementById('test-stats');
            
            statusDiv.textContent = 'Prueba completada';
            
            statsDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value">${stats.requests_per_second}</div>
                        <div class="stat-label">Requests/seg</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.avg_response_time_ms}ms</div>
                        <div class="stat-label">Tiempo promedio</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.success_rate_percent}%</div>
                        <div class="stat-label">Tasa de éxito</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${stats.total_time_seconds}s</div>
                        <div class="stat-label">Tiempo total</div>
                    </div>
                </div>
            `;
            
            statsDiv.style.display = 'block';
            
            // Crear gráfico de tiempos de respuesta
            createResponseChart(results.response_times);
        }

        // Crear gráfico
        function createResponseChart(responseTimes) {
            const canvas = document.getElementById('response-chart');
            canvas.style.display = 'block';
            
            if (responseChart) {
                responseChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            responseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: responseTimes.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Tiempo de respuesta (ms)',
                        data: responseTimes,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tiempos de Respuesta por Request'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tiempo (ms)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Request #'
                            }
                        }
                    }
                }
            });
        }

        // Probar servicios locales
        document.getElementById('test-local').addEventListener('click', function() {
            const resultsDiv = document.getElementById('local-results');
            resultsDiv.innerHTML = '<div>Probando servicios...</div>';
            
            fetch('/api/test-local')
                .then(response => response.json())
                .then(data => {
                    let html = '<div class="services-grid">';
                    for (const [service, result] of Object.entries(data)) {
                        const statusClass = result.status === 'OK' ? 'success' : 'error';
                        html += `
                            <div class="service-result ${statusClass}">
                                <div class="service-name">${service}</div>
                                <div class="service-status">${result.status}</div>
                                <div class="service-time">${result.response_time_ms}ms</div>
                            </div>
                        `;
                    }
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                })
                .catch(error => {
                    resultsDiv.innerHTML = '<div class="error">Error probando servicios</div>';
                    console.error('Error:', error);
                });
        });

        // Inicializar
        updateSystemInfo();
        systemInfoInterval = setInterval(updateSystemInfo, 2000);
    </script>
</body>
</html>